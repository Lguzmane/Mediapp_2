/* =========================================================
   CREACIÓN DE USUARIO Y ASIGNACIÓN DE PRIVILEGIOS
   ========================================================= */
CREATE USER MEDIAPP IDENTIFIED BY salud
  DEFAULT TABLESPACE USERS
  TEMPORARY TABLESPACE TEMP
  QUOTA UNLIMITED ON USERS;

GRANT CONNECT, RESOURCE, CREATE SESSION, CREATE TABLE, CREATE SEQUENCE, CREATE VIEW, CREATE TRIGGER TO MEDIAPP;

/* =========================================================
   TABLAS DEL PROYECTO (basadas en models.py final)
   ========================================================= */
-- Usuario personalizado
CREATE TABLE MEDIAPP_USUARIO (
    ID NUMBER PRIMARY KEY,
    PASSWORD VARCHAR2(255) NOT NULL,
    LAST_LOGIN DATE NULL,
    IS_SUPERUSER NUMBER(1) DEFAULT 0,
    USERNAME VARCHAR2(150) NOT NULL,
    FIRST_NAME VARCHAR2(150),
    LAST_NAME VARCHAR2(150),
    RUT VARCHAR2(12) UNIQUE NOT NULL,
    TIPO_USUARIO VARCHAR2(10) CHECK (TIPO_USUARIO IN ('paciente','medico','admin')),
    TELEFONO VARCHAR2(20),
    DIRECCION CLOB,
    FECHA_NACIMIENTO DATE,
    EMAIL VARCHAR2(254) UNIQUE NOT NULL,
    GENERO VARCHAR2(17),
    NACIONALIDAD VARCHAR2(50),
    GRUPO_SANGUINEO VARCHAR2(5),
    ALERGIAS CLOB,
    CONDICIONES_MEDICAS CLOB,
    MEDICAMENTOS CLOB,
    CIRUGIAS_PREVIAS CLOB,
    IS_STAFF NUMBER(1) DEFAULT 0,
    IS_ACTIVE NUMBER(1) DEFAULT 1,
    DATE_JOINED DATE DEFAULT SYSDATE
);

-- Especialidad
CREATE TABLE MEDIAPP_ESPECIALIDAD (
    ID NUMBER PRIMARY KEY,
    NOMBRE VARCHAR2(50) NOT NULL,
    DESCRIPCION CLOB
);

-- Médico
CREATE TABLE MEDIAPP_MEDICO (
    ID NUMBER PRIMARY KEY,
    USUARIO_ID NUMBER NOT NULL,
    ESPECIALIDAD_ID NUMBER,
    "AÑOS_EXPERIENCIA" NUMBER DEFAULT 0,
    REGISTRO_MEDICO VARCHAR2(50) NOT NULL,
    CONSTRAINT FK_MEDICO_USUARIO FOREIGN KEY (USUARIO_ID) REFERENCES MEDIAPP_USUARIO(ID) ON DELETE CASCADE,
    CONSTRAINT FK_MEDICO_ESP FOREIGN KEY (ESPECIALIDAD_ID) REFERENCES MEDIAPP_ESPECIALIDAD(ID)
);

-- Cita
CREATE TABLE MEDIAPP_CITA (
    ID NUMBER PRIMARY KEY,
    PACIENTE_ID NUMBER NOT NULL,
    MEDICO_ID NUMBER NOT NULL,
    ESPECIALIDAD_ID NUMBER,
    FECHA DATE NOT NULL,
    HORA DATE NOT NULL,
    ESTADO VARCHAR2(20) CHECK (ESTADO IN ('agendada','cancelada','completada')),
    MOTIVO_CANCELACION CLOB,
    FECHA_CREACION DATE DEFAULT SYSDATE,
    CONSTRAINT FK_CITA_PAC FOREIGN KEY (PACIENTE_ID) REFERENCES MEDIAPP_USUARIO(ID),
    CONSTRAINT FK_CITA_MED FOREIGN KEY (MEDICO_ID) REFERENCES MEDIAPP_MEDICO(ID),
    CONSTRAINT FK_CITA_ESP FOREIGN KEY (ESPECIALIDAD_ID) REFERENCES MEDIAPP_ESPECIALIDAD(ID)
);

-- Agenda médica
CREATE TABLE MEDIAPP_AGENDAMEDICA (
    ID NUMBER PRIMARY KEY,
    MEDICO_ID NUMBER NOT NULL,
    DIA_SEMANA VARCHAR2(10) CHECK (DIA_SEMANA IN ('lunes','martes','miércoles','jueves','viernes')),
    HORA_INICIO DATE NOT NULL,
    HORA_FIN DATE NOT NULL,
    DURACION_CITA NUMBER DEFAULT 30,
    CONSTRAINT FK_AGENDA_MED FOREIGN KEY (MEDICO_ID) REFERENCES MEDIAPP_MEDICO(ID)
);

-- Bloqueo de agenda
CREATE TABLE MEDIAPP_BLOQUEOAGENDA (
    ID NUMBER PRIMARY KEY,
    MEDICO_ID NUMBER NOT NULL,
    FECHA_INICIO DATE NOT NULL,
    FECHA_FIN DATE NOT NULL,
    MOTIVO VARCHAR2(255),
    CONSTRAINT FK_BLOQ_MED FOREIGN KEY (MEDICO_ID) REFERENCES MEDIAPP_MEDICO(ID)
);

/* =========================================================
   DATOS DE PRUEBA
   ========================================================= */
-- Especialidades
INSERT INTO MEDIAPP_ESPECIALIDAD (ID, NOMBRE, DESCRIPCION) VALUES (1, 'Pediatría', 'Atención médica para niños y adolescentes.');
INSERT INTO MEDIAPP_ESPECIALIDAD (ID, NOMBRE, DESCRIPCION) VALUES (2, 'Cardiología', 'Atención del corazón y sistema circulatorio.');
INSERT INTO MEDIAPP_ESPECIALIDAD (ID, NOMBRE, DESCRIPCION) VALUES (3, 'Medicina General', 'Atención integral para todas las edades.');

-- Usuarios (contraseña real se resetea con `python manage.py shell`)
INSERT INTO MEDIAPP_USUARIO (ID, PASSWORD, USERNAME, FIRST_NAME, LAST_NAME, RUT, TIPO_USUARIO, EMAIL, IS_SUPERUSER, IS_STAFF, IS_ACTIVE, DATE_JOINED)
VALUES (1, 'changeme', 'kentakakura', 'Ken', 'Takakura', '11111111-1', 'medico', 'ken@gmail.com', 0, 0, 1, SYSDATE);
INSERT INTO MEDIAPP_USUARIO VALUES (2, 'changeme', NULL, 0, 'momoayase', 'Momo', 'Ayase', '22222222-2', 'medico', '', '', NULL, 'momo@gmail.com', '', '', '', '', '', '', '', 0, 1, SYSDATE);
INSERT INTO MEDIAPP_USUARIO VALUES (3, 'changeme', NULL, 0, 'eloisa', 'Eloisa', 'Aguilera', '33333333-3', 'medico', '', '', NULL, 'eloisa@gmail.com', '', '', '', '', '', '', '', 0, 1, SYSDATE);
INSERT INTO MEDIAPP_USUARIO VALUES (4, 'changeme', NULL, 0, 'alonso', 'Alonso', 'Aguilera', '44444444-4', 'medico', '', '', NULL, 'alonso@gmail.com', '', '', '', '', '', '', '', 0, 1, SYSDATE);
INSERT INTO MEDIAPP_USUARIO VALUES (5, 'changeme', NULL, 0, 'favello', 'Felipe', 'Avello', '55555555-5', 'medico', '', '', NULL, 'felipe@gmail.com', '', '', '', '', '', '', '', 0, 1, SYSDATE);
INSERT INTO MEDIAPP_USUARIO VALUES (6, 'changeme', NULL, 0, 'donfran', 'Don', 'Francisco', '66666666-6', 'medico', '', '', NULL, 'don@gmail.com', '', '', '', '', '', '', '', 0, 1, SYSDATE);
INSERT INTO MEDIAPP_USUARIO VALUES (7, 'changeme', NULL, 0, 'lguzman', 'Lorena', 'Guzman', '176354321', 'paciente', '', '', NULL, 'lorena@gmail.com', '', '', '', '', '', '', '', 0, 1, SYSDATE);

-- Médicos
INSERT INTO MEDIAPP_MEDICO (ID, USUARIO_ID, ESPECIALIDAD_ID, "AÑOS_EXPERIENCIA", REGISTRO_MEDICO) VALUES (1, 1, 1, 10, 'RM-001');
INSERT INTO MEDIAPP_MEDICO (ID, USUARIO_ID, ESPECIALIDAD_ID, "AÑOS_EXPERIENCIA", REGISTRO_MEDICO) VALUES (2, 2, 1,  8, 'RM-002');
INSERT INTO MEDIAPP_MEDICO (ID, USUARIO_ID, ESPECIALIDAD_ID, "AÑOS_EXPERIENCIA", REGISTRO_MEDICO) VALUES (3, 3, 2, 15, 'RM-003');
INSERT INTO MEDIAPP_MEDICO (ID, USUARIO_ID, ESPECIALIDAD_ID, "AÑOS_EXPERIENCIA", REGISTRO_MEDICO) VALUES (4, 4, 2, 12, 'RM-004');
INSERT INTO MEDIAPP_MEDICO (ID, USUARIO_ID, ESPECIALIDAD_ID, "AÑOS_EXPERIENCIA", REGISTRO_MEDICO) VALUES (5, 5, 3, 20, 'RM-005');
INSERT INTO MEDIAPP_MEDICO (ID, USUARIO_ID, ESPECIALIDAD_ID, "AÑOS_EXPERIENCIA", REGISTRO_MEDICO) VALUES (6, 6, 3, 25, 'RM-006');

-- Agendas (ejemplo: lunes–viernes 09:00–13:00, cada 30 min)
INSERT INTO MEDIAPP_AGENDAMEDICA (ID, MEDICO_ID, DIA_SEMANA, HORA_INICIO, HORA_FIN, DURACION_CITA)
VALUES (101, 1, 'lunes', TO_DATE('09:00','HH24:MI'), TO_DATE('13:00','HH24:MI'), 30);

-- Bloqueos de agenda (ejemplo)
INSERT INTO MEDIAPP_BLOQUEOAGENDA (ID, MEDICO_ID, FECHA_INICIO, FECHA_FIN, MOTIVO)
VALUES (201, 3, TO_DATE('2025-08-14 10:00','YYYY-MM-DD HH24:MI'), TO_DATE('2025-08-14 11:00','YYYY-MM-DD HH24:MI'), 'Reunión');

-- Citas de prueba
INSERT INTO MEDIAPP_CITA (ID, PACIENTE_ID, MEDICO_ID, ESPECIALIDAD_ID, FECHA, HORA, ESTADO, FECHA_CREACION)
VALUES (301, 7, 3, 2, DATE '2025-08-12', TO_DATE('11:00','HH24:MI'), 'agendada', SYSDATE);

COMMIT;

/* =========================================================
   CONSULTAS DE VERIFICACIÓN
   ========================================================= */
SELECT COUNT(*) FROM MEDIAPP_USUARIO;
SELECT COUNT(*) FROM MEDIAPP_MEDICO;
SELECT COUNT(*) FROM MEDIAPP_CITA;
